#!/usr/bin/env bash

JUNITPATH="/libs/junit5.jar"

if [[ -f ${JUNITPATH} ]]; then
    cp ${JUNITPATH} ../
fi

# Keep original Makefile checks from main
if [[ ! -f Makefile ]]; then
    echo
    echo "Submission Failed Check: no Makefile found"
    exit 1
fi

if ! make -n runApplication ; then
    echo
    echo "Submission Failed Check: Makefile does not include the target runApplication"
    exit 1
fi

if ! make -n runAllTests ; then
    echo
    echo "Submission Failed Check: Makefile does not include the target runAllTests"
    exit 1
fi

if ! make -n clean ; then
    echo
    echo "Submission Failed Check: Makefile does not include the target clean"
    exit 1
fi

if grep -Pv '//' App.java | grep -Pq "_Placeholder"; then
    echo
    echo "Submission Failed Check: App.java includes references to Tree_Placeholder or Backend_Placeholder"
    exit 1
fi

# Keep additional IterableRedBlackTree tests from tree
if ! javac -cp ../junit5.jar:. *.java; then
    echo
    echo "Submission Failed Check: cannot compile IterableRedBlackTree.java"
    exit 1
fi

if ! java -jar ../junit5.jar --class-path=. --select-class=P106SubmissionChecker; then
    echo
    echo "Submission Failed Check: one or more JUnit tests failed; if you have completed the P106 assignment up until and including step 4 and the testNonNullIterator test passes, you have completed all the work required by the midweek deadline (Sat, March 1)"
    exit 1
fi

# Ensure groupAndRole.txt exists
if [[ ! -f groupAndRole.txt ]]; then
  echo "Warning Submission Incomplete: submission does not contain groupAndRole.txt, which should not have been deleted."
  exit 1
fi

ROLE=$(cat groupAndRole.txt | grep -Pio "Backend|Frontend")
ROLEFILE="${ROLE~}.java"
ROLETEST="${ROLE~}Tests.java"
ROLEINTRF="${ROLE~}Interface.java"

if [[ ! -f ${ROLEFILE} ]]; then
  echo "Warning Submission Incomplete: submission does not contain ${ROLEFILE}, but should"
  exit 1
fi

if ! grep -Pzq "implements[^\{]{1,100}${ROLEINTRF%\.java}" ${ROLEFILE}; then
  echo "Warning Submission Incomplete: ${ROLEFILE} does not implement ${ROLEINTRF%\.java}, but should"
  exit 1
fi

if ! javac -cp .:${JUNITPATH} ${ROLEFILE}; then
  echo "Warning Submission Incomplete: ${ROLEFILE} does not compile, but should"
  exit 1
fi

if ! grep -Pzq "@(Parameterized)?Test[^\(]{1,15}(public)? void ${ROLE,,}Test1" ${ROLETEST}; then
  echo "Warning Submission Incomplete: ${ROLETEST} does not contain a JUnit test method called ${ROLE,,}Test1, but should"
  exit 1
fi

if ! grep -Pzq "@(Parameterized)?Test[^\(]{1,15}(public)? void ${ROLE,,}Test2" ${ROLETEST}; then
  echo "Warning Submission Incomplete: ${ROLETEST} does not contain a JUnit test method called ${ROLE,,}Test2, but should"
  exit 1
fi

if ! grep -Pzq "@(Parameterized)?Test[^\(]{1,15}(public)? void ${ROLE,,}Test3" ${ROLETEST}; then
  echo "Warning Submission Incomplete: ${ROLETEST} does not contain a JUnit test method called ${ROLE,,}Test3, but should"
  exit 1
fi

echo "Submission Passed Basic Scan"
exit 0

